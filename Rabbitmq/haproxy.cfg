global
    log stdout format raw local0
    maxconn 4096

defaults
    log     global
    mode    tcp
    option  tcplog
    retries 3
    option redispatch
    maxconn 2000
    timeout connect 5s
    timeout client  50s
    timeout server  50s

# ── HAProxy Stats
listen stats
    bind *:1936
    mode http
    stats enable
    stats hide-version
    stats realm Haproxy\ Statistics
    stats uri /

# ── AMQP (TCP : 5672)
listen rabbitmq_amqp
    bind *:5672
    mode            tcp
    balance         roundrobin
    timeout client  3h
    timeout server  3h
    option          clitcpka
    server          rabbitmq1 rabbitmq1:5672  check inter 5s rise 2 fall 3
    server          rabbitmq2 rabbitmq2:5672  check inter 5s rise 2 fall 3
    server          rabbitmq3 rabbitmq3:5672  check inter 5s rise 2 fall 3

# ── STOMP (TCP : 61613)
listen rabbitmq_stomp
    bind *:61613
    mode            tcp
    balance         roundrobin
    timeout client  3h
    timeout server  3h
    option          clitcpka
    server          rabbitmq1 rabbitmq1:61613 check inter 5s rise 2 fall 3
    server          rabbitmq2 rabbitmq2:61613 check inter 5s rise 2 fall 3
    server          rabbitmq3 rabbitmq3:61613 check inter 5s rise 2 fall 3

# ── Management UI (HTTP : 15672)
frontend mgmt_in
    mode http
    bind *:15672
    default_backend mgmt_back

backend mgmt_back
    mode http
    balance roundrobin
    option httpchk GET /
    server rabbitmq1 rabbitmq1:15672 check inter 5s rise 2 fall 3
    server rabbitmq2 rabbitmq2:15672 check inter 5s rise 2 fall 3
    server rabbitmq3 rabbitmq3:15672 check inter 5s rise 2 fall 3

# ── Web-STOMP (HTTP/WebSocket : 15674)
#    웹소켓은 HTTP 업그레이드로 동작 → mode http로 처리
frontend webstomp_in
    mode http
    bind *:15674
    default_backend webstomp_back
    option httplog

backend webstomp_back
    mode http
    balance roundrobin
    option httpchk GET /
    # WebSocket 관련 기본 동작은 자동 처리됨(HAProxy 2.x+)
    server rabbitmq1 rabbitmq1:15674 check inter 5s rise 2 fall 3
    server rabbitmq2 rabbitmq2:15674 check inter 5s rise 2 fall 3
    server rabbitmq3 rabbitmq3:15674 check inter 5s rise 2 fall 3
